<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/admin.css">
  <style>
    .tabs {
      display: flex;
      gap: 1rem;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 2rem;
    }
    
    .tab-button {
      padding: 0.75rem 1.5rem;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 1rem;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }
    
    .tab-button.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }
    
    .tab-button:hover {
      color: var(--text-color);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-color);
      font-weight: 500;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 0.75rem;
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 5px;
      color: var(--text-color);
      font-family: inherit;
      font-size: 1rem;
    }
    
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
    }
    
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    .btn-primary:hover {
      opacity: 0.9;
    }
    
    .btn-danger {
      background-color: var(--danger-color);
      color: white;
    }
    
    .btn-danger:hover {
      opacity: 0.9;
    }
    
    .btn-secondary {
      background-color: var(--secondary-color);
      color: white;
    }
    
    .btn-secondary:hover {
      opacity: 0.9;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    .array-input-group {
      background-color: var(--surface-color);
      padding: 1rem;
      border-radius: 5px;
      border: 1px solid var(--border-color);
    }
    
    .array-item {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .array-item input {
      flex: 1;
    }
    
    .array-item button {
      padding: 0.5rem 1rem;
      background-color: var(--danger-color);
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    
    .add-btn {
      padding: 0.5rem 1rem;
      background-color: var(--success-color);
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    
    .problems-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .problem-card {
      background-color: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 5px;
      padding: 1rem;
    }
    
    .problem-card h3 {
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }
    
    .problem-card-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .problem-card-actions button {
      flex: 1;
      padding: 0.5rem;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background-color: var(--surface-color);
      padding: 2rem;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .modal-header h2 {
      color: var(--text-color);
      margin: 0;
    }
    
    .close-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.5rem;
      cursor: pointer;
    }
    
    .message {
      padding: 1rem;
      border-radius: 5px;
      margin-bottom: 1rem;
      display: none;
    }
    
    .message.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }
    
    .message.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .cheating-summary {
      margin-bottom: 2rem;
    }

    .summary-card {
      background-color: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 5px;
      padding: 1.5rem;
      text-align: center;
    }

    .summary-card h3 {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin: 0 0 0.5rem 0;
      text-transform: uppercase;
    }

    .summary-card .value {
      color: var(--primary-color);
      font-size: 2rem;
      font-weight: bold;
    }

    .cheating-records-container {
      overflow-x: auto;
    }

    .cheating-table {
      width: 100%;
      border-collapse: collapse;
      background-color: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 5px;
      overflow: hidden;
    }

    .cheating-table thead {
      background-color: var(--bg-color);
      border-bottom: 2px solid var(--border-color);
    }

    .cheating-table th {
      padding: 1rem;
      text-align: left;
      color: var(--text-muted);
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
    }

    .cheating-table td {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .cheating-table tbody tr:hover {
      background-color: rgba(0, 123, 255, 0.05);
    }

    .cheating-type-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .badge-tab-switch {
      background-color: #cfe2ff;
      color: #084298;
    }

    .badge-window-blur {
      background-color: #f8d7da;
      color: #721c24;
    }

    .badge-right-click {
      background-color: #d1e7dd;
      color: #0f5132;
    }

    .badge-fullscreen-exit {
      background-color: #d3d3f8;
      color: #3f38b8;
    }

    .no-records {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }
  </style>
</head>
<body>

  <main class="container">
    <!-- Tabs Navigation -->
    <div class="tabs">
      <button class="tab-button active" onclick="switchTab('teams')">Registered Teams</button>
      <button class="tab-button" onclick="switchTab('submissions')">Submissions</button>
      <button class="tab-button" onclick="switchTab('problems')">Problem Management</button>
      <button class="tab-button" onclick="switchTab('cheating')">Cheating Records</button>
    </div>

    <!-- Teams Tab -->
    <div id="teams" class="tab-content active">
      <h1>Registered Teams</h1>
      <p class="subtitle">Live data of Registered Participants</p>

      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Search by name, branch, or code...">
      </div>

      <% if (participants.length > 0) { %>
        <table class="participant-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Team Code</th>
              <th>Type</th>
              <th>Participants</th>
              <th>Registered At</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="participantTable">
            <% participants.forEach((team, index) => { %>
              <tr>
                <td><%= index + 1 %></td>
                <td><strong><%= team.code || "N/A" %></strong></td>
                <td>
                  <% if (team.type) { %>
                    <span class="type-badge <%= team.type === 'duet' ? 'duet' : 'solo' %>">
                      <%= team.type.charAt(0).toUpperCase() + team.type.slice(1) %>
                    </span>
                  <% } else { %>
                    <em>Unknown</em>
                  <% } %>
                </td>
                <td>
                  <% if (Array.isArray(team.participants)) { %>
                    <% team.participants.forEach((p, i) => { %>
                      <div class="participant-block">
                        Name: <%= p.name || "N/A" %><br>
                        Email: <%= p.email || "N/A" %><br>
                        Phone: <%= p.phone || "N/A" %><br>
                        Branch: <%= p.branch || "N/A" %><br>
                        Semester: <%= p.semester || "N/A" %>
                      </div>
                      <% if (i === 0 && team.participants.length > 1) { %><hr><% } %>
                    <% }) %>
                  <% } else { %>
                    <em>No participant data</em>
                  <% } %>
                </td>
                <td><%= team.createdAt ? new Date(team.createdAt._seconds * 1000).toLocaleString() : "N/A" %></td>
                <td>
                  <form action="/admin/delete" method="POST" onsubmit="return confirmDelete()">
                    <input type="hidden" name="id" value="<%= team.id %>">
                    <button class="btn btn-danger">Delete</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } else { %>
        <p class="no-data">No registered teams found.</p>
      <% } %>
    </div>

    <!-- Submissions Tab -->
    <div id="submissions" class="tab-content">
      <h1>Team Submissions</h1>
      <p class="subtitle">View and quickly evaluate team submissions</p>

      <div class="cheating-filters" style="margin-bottom: 1rem; display:flex; gap:1rem; flex-wrap:wrap;">
        <input type="text" id="filterSubmissionTeam" placeholder="Filter by Team Code..." style="min-width:200px; flex:1">
        <input type="text" id="filterSubmissionEmail" placeholder="Filter by Email..." style="min-width:200px; flex:1">
        <select id="filterSubmissionDifficulty" style="min-width:150px;">
          <option value="">All Difficulties</option>
          <option value="easy">Easy</option>
          <option value="medium">Medium</option>
          <option value="hard">Hard</option>
        </select>
        <button class="btn btn-primary" onclick="loadSubmissions()" style="flex:0 0 auto;">Refresh</button>
      </div>

      <div id="submissionsContainer">
        <!-- Submissions table will be rendered here -->
      </div>
    </div>

    <!-- Problems Tab -->
    <div id="problems" class="tab-content">
      <h1>Problem Management</h1>
      <p class="subtitle">Add, edit, or delete contest problems</p>

      <div id="message" class="message"></div>

      <button class="btn btn-primary" onclick="openAddProblemModal()">+ Add New Problem</button>

      <div id="problemsList" class="problems-list">
        <!-- Problems will be loaded here -->
      </div>
    </div>

    <!-- Cheating Records Tab -->
    <div id="cheating" class="tab-content">
      <h1>Cheating Records</h1>
      <p class="subtitle">Monitor integrity violations and suspicious activities</p>

      <div id="cheatingSummary" class="cheating-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <!-- Summary cards will be loaded here -->
      </div>

      <div class="cheating-filters" style="margin-bottom: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
        <input type="text" id="filterTeamCode" placeholder="Filter by Team Code..." style="flex: 1; min-width: 200px;">
        <input type="text" id="filterEmail" placeholder="Filter by Email..." style="flex: 1; min-width: 200px;">
        <select id="filterCheatingType" style="flex: 1; min-width: 150px;">
          <option value="">All Cheating Types</option>
          <option value="tab_switch">Tab Switch</option>
          <option value="window_blur">Window Blur</option>
          <option value="right_click">Right Click</option>
          <option value="fullscreen_exit">Fullscreen Exit</option>
        </select>
        <button class="btn btn-primary" onclick="loadCheatingRecords()" style="flex: 0 0 auto;">Refresh</button>
      </div>

      <div id="cheatingRecordsContainer" class="cheating-records-container">
        <!-- Cheating records table will be loaded here -->
      </div>
    </div>
  </main>

  <!-- Add/Edit Problem Modal -->
  <div id="problemModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Add New Problem</h2>
        <button class="close-btn" onclick="closeProblemModal()">&times;</button>
      </div>

      <form id="problemForm">
        <div class="form-group">
          <label for="title">Title *</label>
          <input type="text" id="title" name="title" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="difficulty">Difficulty *</label>
            <select id="difficulty" name="difficulty" required>
              <option value="easy">Easy</option>
              <option value="medium">Medium</option>
              <option value="hard">Hard</option>
            </select>
          </div>

          <div class="form-group">
            <label for="order">Order *</label>
            <input type="number" id="order" name="order" required min="1">
          </div>
        </div>

        <div class="form-group">
          <label for="description">Description *</label>
          <textarea id="description" name="description" required></textarea>
        </div>

        <!-- Examples -->
        <div class="form-group">
          <label>Examples</label>
          <div id="examplesContainer" class="array-input-group">
            <!-- Examples will be added here -->
          </div>
          <button type="button" class="add-btn" onclick="addExample()">+ Add Example</button>
        </div>

        <!-- Constraints -->
        <div class="form-group">
          <label>Constraints</label>
          <div id="constraintsContainer" class="array-input-group">
            <!-- Constraints will be added here -->
          </div>
          <button type="button" class="add-btn" onclick="addConstraint()">+ Add Constraint</button>
        </div>

        <div class="form-group">
          <label for="hasSubQuestions">
            <input type="checkbox" id="hasSubQuestions" name="hasSubQuestions">
            Has Sub-Questions (Easy level only)
          </label>
        </div>

        <!-- Code Snippets Section -->
        <div class="form-group">
          <label>Code Snippets</label>
          <div id="snippetsContainer" class="array-input-group">
            <!-- Snippets will be added here -->
          </div>
          <button type="button" class="add-btn" onclick="addSnippet()">+ Add Code Snippet</button>
        </div>

        <div class="form-group">
          <button type="submit" class="btn btn-primary">Save Problem</button>
          <button type="button" class="btn btn-secondary" onclick="closeProblemModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function confirmDelete() {
      return confirm('Are you sure you want to delete this registration?');
    }

    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });

      // Show selected tab
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');

      // Load problems if switching to problems tab
      if (tabName === 'problems') {
        loadProblems();
      }

      // Load cheating records if switching to cheating tab
      if (tabName === 'cheating') {
        loadCheatingRecords();
      }
      // Load submissions if switching to submissions tab
      if (tabName === 'submissions') {
        loadSubmissions();
      }
    }
  </script>

  <script src="/js/admin.js"></script>
</body>
</html>
